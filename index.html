<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsicoQuiz | Portal de Testes Psicológicos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos gerais */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; background-image: url('mente.png'); background-size: cover; background-position: center; background-attachment: fixed; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        .quiz-container { max-width: 800px; }
        .likert-option { cursor: pointer; transition: all 0.2s; }
        .likert-option:hover { background-color: #eff6ff; }
        .selected-option { background-color: #1d4ed8 !important; color: white; font-weight: 700; box-shadow: 0 0 0 4px #EC4899; transform: scale(1.05); border-color: transparent !important; }
        .quiz-card-select { cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; position: relative; overflow: hidden; border: 4px solid #f8f8f8; min-height: 250px; border-radius: 1rem; }
        .quiz-card-select::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.45); z-index: 1; border-radius: inherit; }
        .quiz-card-select:hover { transform: translateY(-5px); box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.2); }
        .quiz-content { position: relative; z-index: 2; }
        #card-burnout { background-image: url('bernalt.png'); }
        #card-qi { background-image: url('qi.png'); background-color: #3b82f6; }
        #card-stress { background-image: url('estresse.png'); }
        #card-anxiety { background-image: url('ansiedade.png'); }
        #card-sadness { background-image: url('triste.png'); }
        #card-humility { background-image: url('humilde.png'); }
        #card-arrogance { background-image: url('arrogante.png'); }
        .bg-cover-center { background-size: cover; background-position: center; background-repeat: no-repeat; }
        .modal { background-color: rgba(0, 0, 0, 0.7); }
        .text-shadow { text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); }
        .old-price { text-decoration: line-through; opacity: 0.7; }
        #payment-button-container { min-height: 50px; display: flex; justify-content: center; align-items: center; margin-top: 1rem; }
        #loading-screen { background-color: rgba(255, 255, 255, 0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #EC4899; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-3xl font-extrabold text-pink-600">Psico</span>
                <span class="text-3xl font-extrabold text-gray-800">Quiz</span>
            </div>
        </nav>
    </header>

    <main>
        <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-20 text-center" id="quiz-selection">
            <h1 class="text-5xl sm:text-6xl lg:text-7xl font-extrabold leading-tight text-white mb-4 text-shadow" style="color: #EC4899;">DESVENDE SUA MENTE</h1>
            <p class="text-xl text-white mb-12 text-shadow font-semibold">Escolha o teste psicológico que mais se encaixa com o momento atual da sua vida.</p>
            <div id="quiz-cards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </section>

        <section id="quiz-section" class="quiz-container mx-auto px-4 sm:px-6 lg:px-8 py-16 hidden">
            <div class="bg-slate-50 p-6 sm:p-10 rounded-xl shadow-2xl">
                <h2 id="active-quiz-title" class="text-3xl font-bold text-center mb-8 text-gray-900"></h2>
                <div id="quiz-questions" class="space-y-6">
                    </div>
                <div class="text-center mt-10">
                    <button id="submit-quiz-btn" class="px-8 py-3 bg-pink-600 text-white text-lg font-bold rounded-lg shadow-lg hover:bg-pink-700 transition duration-300 hidden">VER MEU RESULTADO FINAL</button>
                </div>
                <div id="quiz-result" class="mt-10 p-6 bg-slate-100 rounded-lg hidden">
                    </div>
            </div>
        </section>

        <section class="bg-gray-100 py-16 mt-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl sm:text-4xl font-bold text-center mb-8 text-gray-900">Sobre a PsicoQuiz</h2>
                <p class="text-center text-lg text-gray-600 max-w-4xl mx-auto">A PsicoQuiz nasceu da necessidade de democratizar o acesso ao autoconhecimento. Acreditamos que todos merecem ferramentas valiosas para entender sua própria mente. Nossos testes são desenvolvidos com base em conceitos da psicologia, mas servem como um ponto de partida para sua jornada pessoal. Lembre-se: Autoconhecimento é poder!</p>
            </div>
        </section>
    </main>

    <footer class="bg-gray-900 text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-sm">&copy; 2025 PsicoQuiz. Todos os direitos reservados.</p>
            <p class="text-xs mt-2 text-gray-500">Atenção: Nossos testes são ferramentas de autoavaliação e não substituem um diagnóstico clínico profissional.</p>
        </div>
    </footer>

    <div id="purchase-modal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-900 mb-4">Seu Relatório está Pronto!</h3>
            <p class="text-gray-700 mb-4">Seu diagnóstico foi concluído. Desbloqueie o **Relatório Completo** para revelar sua análise detalhada e plano de ação personalizado.</p>
            <p class="text-gray-500 text-lg old-price">De R$ 25,00</p>
            <p id="modal-price" class="text-4xl font-extrabold text-red-600 mb-4">Por R$ 8,99</p>

            <div id="payment-button-container" class="mb-4">
                <script src="https://www.mercadopago.com.br/integrations/v1/web-payment-checkout.js"
                        data-preference-id="210637269-9fa0440d-9820-4a4c-a664-5eab8b06f0cc"
                        data-source="button">
                </script>
            </div>

            <p class="text-xs text-gray-500 mb-4">A transação será processada no ambiente seguro do Mercado Pago.</p>
            <button id="close-modal-btn" class="text-sm text-gray-500 hover:text-gray-700 transition">Cancelar</button>
        </div>
    </div>

    <div id="loading-screen" class="fixed inset-0" style="display: none;">
        <div class="loader"></div>
        <p class="mt-4 text-xl font-semibold text-gray-700">Verificando Pagamento...</p>
        <p class="text-sm text-gray-500">Aguarde, estamos liberando seu resultado.</p>
    </div>

    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- CHAVES E PREÇOS ---
        // !!! SUBSTITUA PELA SUA NOVA PUBLIC KEY DA APP "PsicoQuizz" !!!
        const MERCADO_PAGO_PUBLIC_KEY = 'APP_USR-COLE_SUA_NOVA_PUBLIC_KEY_AQUI';
        // Este ID veio do seu script estático. Verifique se ele está correto e associado à App "PsicoQuizz"
        const PREFERENCE_ID_PARA_SCRIPT = "210637269-9fa0440d-9820-4a4c-a664-5eab8b06f0cc";
        const PRICE_DISPLAY = "R$ 8,99";

        const likertScale = [
            { text: "Nunca", value: 1, class: 'bg-green-100 hover:bg-green-200 text-green-800' },
            { text: "Raramente", value: 2, class: 'bg-lime-100 hover:bg-lime-200 text-lime-800' },
            { text: "Às vezes", value: 3, class: 'bg-yellow-100 hover:bg-yellow-200 text-yellow-800' },
            { text: "Frequentemente", value: 4, class: 'bg-orange-100 hover:bg-orange-200 text-orange-800' },
            { text: "Sempre", value: 5, class: 'bg-red-100 hover:bg-red-200 text-red-800' }
        ];

        let userAnswers = [];
        let activeQuizId = null;

        const mp = new MercadoPago(MERCADO_PAGO_PUBLIC_KEY);

        // --- BANCO DE DADOS DOS QUIZZES ---
        const quizzes = {
            burnout: {
                title: "Teste de Risco de Burnout",
                subtitle: "Avalie sua exaustão emocional, cinismo e eficácia profissional.",
                card_id: "card-burnout",
                image_url: 'bernalt.png',
                questions: ["1. Sinto-me emocionalmente exausto(a) ao final do dia de trabalho.", "2. Sinto-me cansado(a) logo ao acordar...", /* ... (restantes das 30 perguntas) ... */ "30. Sinto que o meu trabalho exige mais de mim do que eu posso dar."],
                inverted_questions: [3, 9, 13, 16, 19, 26, 29],
                get_result: (score) => {
                    if (score <= 65) return { title: "Baixo Risco de Burnout", desc: "Seu relatório indica que você possui um excelente equilíbrio...", color: 'bg-green-500' };
                    if (score <= 105) return { title: "Risco Moderado (Alerta)", desc: "Seu relatório aponta sinais claros de exaustão emocional...", color: 'bg-yellow-500' };
                    return { title: "Alto Risco de Burnout", desc: "Seu relatório mostra um esgotamento crítico...", color: 'bg-red-500' };
                },
                get_specific_advice: (answers) => {
                    let advice = [];
                    if (answers[0] >= 4) advice.push("Vimos que sua **Exaustão Emocional** (Pergunta 1) é um ponto crítico...");
                    if (answers[4] >= 4) advice.push("Você marcou que **Lidar com Pessoas** é um grande estresse (Pergunta 5)...");
                    if (answers[17] >= 4) advice.push("A **falta de controle** sobre as tarefas (Pergunta 18) é um gatilho enorme...");
                    return advice;
                }
            },
            qi: {
                title: "Teste de QI e Raciocínio",
                subtitle: "Avalie sua inteligência fluida...",
                card_id: "card-qi",
                image_url: 'qi.png',
                questions: ["1. Eu resolvo problemas complexos rapidamente...", /* ... (30 perguntas) ... */ "30. Eu sinto que minha mente trabalha em alta velocidade."],
                inverted_questions: [13, 14, 20, 22, 29],
                get_result: (score) => {
                    if (score <= 85) return { title: "Raciocínio Lógico Sólido", desc: "Seu relatório indica uma capacidade funcional...", color: 'bg-yellow-500' };
                    if (score <= 130) return { title: "Raciocínio Acima da Média", desc: "Seu relatório mostra uma inteligência fluida forte...", color: 'bg-green-500' };
                    return { title: "Raciocínio Excepcional", desc: "Seu relatório aponta uma capacidade cognitiva muito elevada...", color: 'bg-blue-600' };
                },
                get_specific_advice: (answers) => {
                    let advice = [];
                    if (answers[13] >= 4) advice.push("Notamos que você tem **dificuldade com gráficos** (Pergunta 14)...");
                    if (answers[3] <= 2) advice.push("Você marcou que **aprender novas habilidades conceituais** (Pergunta 4) é um desafio...");
                    return advice;
                }
            },
            stress: {
                title: "Quão Estressado Eu Sou?",
                subtitle: "Descubra seu nível de tensão...",
                card_id: "card-stress",
                image_url: 'estresse.png',
                questions: ["1. Tenho dificuldade em pegar no sono...", /* ... (30 perguntas) ... */ "30. Tenho tido mais gripes ou problemas de saúde..."],
                inverted_questions: [6, 9, 13, 16, 19, 23, 26, 28],
                get_result: (score) => {
                    if (score <= 60) return { title: "Nível de Stress Saudável (Resiliente)", desc: "Seu relatório indica que você tem uma excelente gestão...", color: 'bg-green-500' };
                    if (score <= 100) return { title: "Nível de Stress Moderado (Sobrecarga)", desc: "Seu relatório aponta que você está acumulando tensão...", color: 'bg-yellow-500' };
                    return { title: "Nível de Stress Alto (Exaustão)", desc: "Seu relatório mostra que seu corpo e mente estão em estado de alerta...", color: 'bg-red-500' };
                },
                get_specific_advice: (answers) => {
                    let advice = [];
                    if (answers[0] >= 4 || answers[2] >= 4) advice.push("Sua **mente acelerada na hora de dormir** (Perguntas 1 e 3)...");
                    if (answers[1] >= 4) advice.push("A **tensão muscular** (Pergunta 2) é seu corpo guardando o estresse...");
                    if (answers[13] >= 4) advice.push("A sensação de **correr contra o tempo** (Pergunta 14) é sobrecarga...");
                    return advice;
                }
            },
             anxiety: {
                title: "Qual o Meu Nível de Ansiedade?",
                subtitle: "Avaliação do seu estado de apreensão...",
                card_id: "card-anxiety",
                image_url: 'ansiedade.png',
                questions: ["1. Sinto palpitações, tonturas...", /* ... (30 perguntas) ... */ "30. Minha qualidade de vida é boa e satisfatória. (Invertida)"],
                inverted_questions: [5, 9, 15, 18, 21, 23, 27, 30],
                get_result: (score) => {
                     if (score <= 65) return { title: "Nível de Ansiedade Baixo (Serenidade)", desc: "Seu relatório indica que você tem uma ótima capacidade...", color: 'bg-green-500' };
                     if (score <= 105) return { title: "Nível de Ansiedade Moderado (Apreensão)", desc: "Seu relatório aponta um estado de apreensão constante...", color: 'bg-yellow-500' };
                     return { title: "Nível de Ansiedade Elevado (Alerta)", desc: "Seu relatório mostra que a ansiedade está impactando sua vida...", color: 'bg-red-500' };
                },
                get_specific_advice: (answers) => {
                    let advice = [];
                    if (answers[0] >= 4 || answers[9] >= 4) advice.push("Os **sintomas físicos** (palpitações, inquietação - Perguntas 1 e 10)...");
                    if (answers[2] >= 4 || answers[5] >= 4) advice.push("Vimos que sua mente vive no futuro, pensando 'algo ruim vai acontecer' ou 'e se...' (Perguntas 3 e 6)...");
                    if (answers[1] >= 4) advice.push("Você está **evitando situações** (Pergunta 2) por medo...");
                    return advice;
                }
            },
            sadness: {
                title: "Quão Triste Estou?",
                subtitle: "Mapeamento do seu humor, energia...",
                card_id: "card-sadness",
                image_url: 'triste.png',
                questions: ["1. Tenho perdido o interesse em atividades...", /* ... (30 perguntas) ... */ "30. Eu me sinto confortável com quem eu sou. (Invertida)"],
                inverted_questions: [6, 9, 13, 16, 18, 20, 23, 27, 29, 30],
                get_result: (score) => {
                    if (score <= 60) return { title: "Humor Estável (Saudável)", desc: "Seu relatório indica um estado emocional equilibrado...", color: 'bg-green-500' };
                    if (score <= 100) return { title: "Tristeza Moderada (Atenção)", desc: "Seu relatório aponta sinais de desânimo...", color: 'bg-yellow-500' };
                    return { title: "Tristeza Significativa (Alerta)", desc: "Seu relatório mostra um estado de humor persistentemente baixo...", color: 'bg-red-500' };
                },
                get_specific_advice: (answers) => {
                    let advice = [];
                    if (answers[0] >= 4 || answers[2] >= 4) advice.push("Sua **perda de interesse e energia** (Perguntas 1 e 3)...");
                    if (answers[10] >= 4) advice.push("O **isolamento** (Pergunta 11) é o 'combustível' da tristeza...");
                    if (answers[6] >= 4) advice.push("Sentimentos de **culpa ou inutilidade** (Pergunta 7) são distorções...");
                    return advice;
                }
            },
            arrogance: {
                title: "Sou Uma Pessoa Arrogante?",
                subtitle: "Avaliação da sua autoimportância...",
                card_id: "card-arrogance",
                image_url: 'arrogante.png',
                questions: ["1. Sinto que sou superior à maioria...", /* ... (30 perguntas) ... */ "30. Eu desconfio facilmente das intenções dos outros."],
                inverted_questions: [4, 7, 9, 12, 14, 16, 17, 20, 22, 23, 26, 28],
                 get_result: (score) => {
                     if (score <= 80) return { title: "Nível Baixo (Modéstia)", desc: "Seu relatório indica que você tem uma visão equilibrada...", color: 'bg-green-500' };
                     if (score <= 120) return { title: "Nível Moderado (Autoconfiança Elevada)", desc: "Seu relatório aponta uma forte autoconfiança...", color: 'bg-yellow-500' };
                     return { title: "Nível Alto (Arrogância)", desc: "Seu relatório sugere que uma necessidade de superioridade...", color: 'bg-red-500' };
                 },
                 get_specific_advice: (answers) => {
                    let advice = [];
                    if (answers[4] >= 4 || answers[7] >= 4) advice.push("A necessidade de **interromper ou corrigir os outros** (Perguntas 5 e 8)...");
                    if (answers[3] >= 4) advice.push("Você marcou que tem dificuldade em **aceitar que outros são mais talentosos** (Pergunta 4)...");
                    if (answers[8] >= 4) advice.push("Vimos que **pedir desculpas** (Pergunta 9) pode ser difícil...");
                    return advice;
                 }
            },
            humility: {
                title: "Sou Uma Pessoa Humilde?",
                subtitle: "Avalie sua abertura a críticas...",
                card_id: "card-humility",
                image_url: 'humilde.png',
                questions: ["1. Admito meus erros facilmente...", /* ... (30 perguntas) ... */ "30. Eu valorizo o esforço tanto quanto o resultado final."],
                inverted_questions: [3, 5, 7, 9, 11, 13, 17, 19, 22, 23, 26, 29],
                get_result: (score) => {
                    if (score <= 80) return { title: "Humildade em Construção", desc: "Seu relatório indica uma forte autoconfiança...", color: 'bg-red-500' };
                    if (score <= 120) return { title: "Humildade Moderada (Equilíbrio)", desc: "Seu relatório aponta um bom equilíbrio...", color: 'bg-yellow-500' };
                    return { title: "Humildade Alta (Abertura)", desc: "Seu relatório mostra uma forte capacidade de autoconhecimento...", color: 'bg-green-500' };
                },
                get_specific_advice: (answers) => {
                    let advice = [];
                    if (answers[1] <= 2) advice.push("Você marcou que **não procura feedback negativo** (Pergunta 2)...");
                    if (answers[8] >= 4) advice.push("Vimos que você acha que **suas opiniões são as mais corretas** (Pergunta 9)...");
                    if (answers[7] <= 2) advice.push("A dificuldade em **elogiar publicamente** (Pergunta 8)...");
                    return advice;
                }
            }
        };

        // --- SELETORES DE ELEMENTOS ---
        const quizCardsGrid = document.getElementById('quiz-cards-grid');
        const quizSelection = document.getElementById('quiz-selection');
        const quizSection = document.getElementById('quiz-section');
        const activeQuizTitle = document.getElementById('active-quiz-title');
        const quizQuestionsContainer = document.getElementById('quiz-questions');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const quizResultArea = document.getElementById('quiz-result');
        const purchaseModal = document.getElementById('purchase-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalPrice = document.getElementById('modal-price');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const loadingScreen = document.getElementById('loading-screen');
        const paymentButtonContainer = document.getElementById('payment-button-container');

        // --- FUNÇÕES DE RENDERIZAÇÃO E INTERAÇÃO ---

        function renderQuizCards() {
            const orderedKeys = ['burnout', 'qi', 'stress', 'anxiety', 'sadness', 'arrogance', 'humility'];
            quizCardsGrid.innerHTML = orderedKeys.map(key => {
                const quiz = quizzes[key];
                return `
                    <div id="${quiz.card_id}" class="quiz-card-select bg-cover-center p-6 rounded-xl shadow-lg flex flex-col justify-end text-white"
                         data-quiz-id="${key}" style="background-image: url('${quiz.image_url}');">
                        <div class="quiz-content">
                            <h3 class="text-2xl font-bold mb-1 text-red-500 text-shadow">${quiz.title}</h3>
                            <p class="text-sm opacity-90 text-white text-shadow">${quiz.subtitle}</p>
                            <span class="inline-block mt-3 px-3 py-1 bg-pink-600 text-white text-xs font-semibold rounded-full hover:bg-pink-700 transition">CLIQUE PARA INICIAR O TESTE</span>
                        </div>
                    </div>`;
            }).join('');
            document.querySelectorAll('.quiz-card-select').forEach(card => card.addEventListener('click', handleQuizSelection));
        }

        function handleQuizSelection(event) {
            activeQuizId = event.currentTarget.getAttribute('data-quiz-id');
            loadQuiz();
        }

        function loadQuiz() {
            if (!activeQuizId) return;
            const quiz = quizzes[activeQuizId];
            userAnswers = new Array(quiz.questions.length).fill(0);
            quizQuestionsContainer.innerHTML = '';
            quizResultArea.classList.add('hidden');
            submitQuizBtn.classList.add('hidden');
            activeQuizTitle.textContent = quiz.title;
            quiz.questions.forEach((questionText, index) => {
                const questionElement = document.createElement('div');
                questionElement.className = 'p-4 bg-white rounded-lg shadow-md';
                questionElement.innerHTML = `
                    <p class="font-semibold mb-3 text-lg">${questionText}</p>
                    <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mt-3" id="options-${index}">
                        ${likertScale.map(option => `<div class="likert-option ${option.class} px-4 py-2 rounded-full text-sm font-medium w-full sm:w-auto text-center" data-question-index="${index}" data-value="${option.value}">${option.text}</div>`).join('')}
                    </div>`;
                quizQuestionsContainer.appendChild(questionElement);
            });
            document.querySelectorAll('.likert-option').forEach(option => option.addEventListener('click', handleOptionClick));
            quizSection.classList.remove('hidden');
            quizSelection.classList.add('hidden');
            quizSection.scrollIntoView({ behavior: 'smooth' });
        }

        function handleOptionClick(event) {
            const element = event.currentTarget;
            const questionIndex = parseInt(element.getAttribute('data-question-index'));
            const value = parseInt(element.getAttribute('data-value'));
            const optionsContainer = document.getElementById(`options-${questionIndex}`);
            optionsContainer.querySelectorAll('.likert-option').forEach(opt => {
                opt.classList.remove('selected-option');
                const originalClasses = likertScale.find(scale => scale.value === parseInt(opt.getAttribute('data-value'))).class;
                opt.className = `likert-option ${originalClasses} px-4 py-2 rounded-full text-sm font-medium w-full sm:w-auto text-center`;
            });
            element.classList.add('selected-option');
            userAnswers[questionIndex] = value;
            checkCompletion();
        }

        function checkCompletion() {
            const allAnswered = userAnswers.every(answer => answer !== 0);
            submitQuizBtn.classList.toggle('hidden', !allAnswered);
        }

        // --- FLUXO DE PAGAMENTO ---

        submitQuizBtn.addEventListener('click', () => {
            const quiz = quizzes[activeQuizId];
            localStorage.setItem('pendingQuiz', JSON.stringify({ id: activeQuizId, answers: userAnswers }));
            modalTitle.textContent = `Seu Relatório de ${quiz.title.replace('Teste de ', '')} está Pronto!`;
            purchaseModal.classList.remove('hidden');

            // Recarrega o script do botão MP para garantir que ele apareça
            const mpScriptExisting = paymentButtonContainer.querySelector('script[src*="mercadopago"]');
            if (mpScriptExisting) {
                const newScript = document.createElement('script');
                newScript.src = mpScriptExisting.src;
                newScript.dataset.preferenceId = PREFERENCE_ID_PARA_SCRIPT;
                newScript.dataset.source = "button";
                paymentButtonContainer.innerHTML = '';
                paymentButtonContainer.appendChild(newScript);
            }
        });

        function unlockAccess(quizId, answers) {
             activeQuizId = quizId;
             userAnswers = answers;
             const quiz = quizzes[activeQuizId];
             if (!quiz) return;

             let totalScore = 0;
             userAnswers.forEach((answer, index) => {
                 const questionNumber = index + 1;
                 if (quiz.inverted_questions && quiz.inverted_questions.includes(questionNumber)) {
                     totalScore += (6 - answer);
                 } else {
                     totalScore += answer;
                 }
             });

            const resultData = quiz.get_result(totalScore);
            let specificAdvice = [];
            // Verifica se a função existe e se o resultado não é 'baixo/saudável'
            if (quiz.get_specific_advice && !(resultData.title.includes('Baixo') || resultData.title.includes('Saudável') || resultData.title.includes('Serenidade') || resultData.title.includes('Modéstia') || resultData.title.includes('Equilíbrio') || resultData.title.includes('Abertura'))) {
                specificAdvice = quiz.get_specific_advice(userAnswers);
            }

            const adviceHtml = specificAdvice.length > 0 ? `
                <p class="text-base text-gray-700 mt-4">
                    <span class="font-bold text-lg text-blue-800">CONSELHOS PERSONALIZADOS (COM BASE NAS SUAS RESPOSTAS):</span>
                    <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                        ${specificAdvice.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </p>` : '';

             const planGeneralHtml = (resultData.title.includes('Baixo') || resultData.title.includes('Saudável') || resultData.title.includes('Serenidade') || resultData.title.includes('Modéstia') || resultData.title.includes('Equilíbrio') || resultData.title.includes('Abertura'))
                 ? `<li><strong>Manutenção:</strong> Seu resultado é positivo! O foco é blindar sua mente. Pratique a gratidão diária...</li><li><strong>Prevenção:</strong> Identifique seus 'gatilhos' de estresse...</li>`
                 : `<li><strong>Ação Urgente:</strong> Sua pontuação sugere atenção. Fale com alguém de confiança...</li><li><strong>Rotina de Sono:</strong> Priorize o sono...</li><li><strong>Ajuda Profissional:</strong> Considere conversar com um profissional...</li>`;

             quizResultArea.innerHTML = `
                 <h3 class="text-3xl font-extrabold text-center mb-4 text-pink-600">✅ ACESSO LIBERADO!</h3>
                 <h4 class="text-xl font-bold text-center mb-4 text-gray-800">Seu Relatório Completo de ${quiz.title.replace('Teste de ', '')}</h4>
                 <div class="p-4 rounded-lg ${resultData.color} text-white text-xl font-bold text-center mb-6">Diagnóstico Principal: ${resultData.title}</div>
                 <h4 class="text-xl font-bold text-gray-900 mb-3">Sua Pontuação: ${totalScore} de ${quiz.questions.length * 5}</h4>
                 <div class="mt-4 p-5 border border-blue-300 rounded-lg bg-blue-50 space-y-4">
                     <p class="text-base text-gray-700"><span class="font-bold text-lg text-blue-800">ANÁLISE PROFUNDA:</span><span class="block mt-1">${resultData.desc}</span></p>
                     ${adviceHtml}
                     <p class="text-base text-gray-700 mt-4"><span class="font-bold text-lg text-blue-800">PLANO DE AÇÃO GERAL:</span><ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">${planGeneralHtml}</ul></p>
                 </div>`;

             quizSection.classList.remove('hidden');
             quizSelection.classList.add('hidden');
             quizQuestionsContainer.innerHTML = ''; // Limpa as perguntas
             submitQuizBtn.classList.add('hidden');
             activeQuizTitle.textContent = ''; // Limpa o título do quiz
             quizResultArea.classList.remove('hidden');
             quizResultArea.scrollIntoView({ behavior: 'smooth' });
        }

        closeModalBtn.addEventListener('click', () => {
            purchaseModal.classList.add('hidden');
            localStorage.removeItem('pendingQuiz'); // Limpa se cancelar
        });

        // --- LÓGICA DE INICIALIZAÇÃO DA PÁGINA ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const pendingQuizData = localStorage.getItem('pendingQuiz');

            if (paymentStatus === 'success' && pendingQuizData) {
                loadingScreen.style.display = 'flex'; // Mostra carregando
                const data = JSON.parse(pendingQuizData);
                setTimeout(() => { // Simula verificação
                    loadingScreen.style.display = 'none'; // Esconde carregando
                    unlockAccess(data.id, data.answers);
                    localStorage.removeItem('pendingQuiz');
                    window.history.replaceState(null, '', window.location.pathname); // Limpa URL
                }, 2000);
            } else if (paymentStatus === 'failed' || paymentStatus === 'pending') {
                alert("Seu pagamento falhou ou foi cancelado. Por favor, tente novamente.");
                localStorage.removeItem('pendingQuiz');
                window.history.replaceState(null, '', window.location.pathname);
                renderQuizCards(); // Mostra a home
            } else {
                renderQuizCards(); // Carregamento normal da home
            }
        });

    </script>
</body>
</html>
